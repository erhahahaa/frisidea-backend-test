services:
    laravel:
        build:
            context: .
            dockerfile: Dockerfile
            target: dev
        container_name: 'frisidea-laravel'
        ports:
            - '${FORWARD_APP_PORT:-80}:80'
        environment:
            # Application Configuration
            APP_NAME: '${APP_NAME}'
            APP_ENV: '${APP_ENV}'
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: '${APP_DEBUG}'
            APP_URL: '${APP_URL}'
            
            # Locale Configuration
            APP_LOCALE: '${APP_LOCALE}'
            APP_FALLBACK_LOCALE: '${APP_FALLBACK_LOCALE}'
            APP_FAKER_LOCALE: '${APP_FAKER_LOCALE}'
            
            # Database Configuration
            DB_CONNECTION: '${DB_CONNECTION}'
            DB_HOST: 'pgsql'
            DB_PORT: '${DB_PORT:-5432}'
            DB_DATABASE: '${DB_DATABASE}'
            DB_USERNAME: '${DB_USERNAME}'
            DB_PASSWORD: '${DB_PASSWORD}'
            
            # Cache Configuration
            CACHE_STORE: '${CACHE_STORE}'
            
            # Queue Configuration
            QUEUE_CONNECTION: '${QUEUE_CONNECTION}'
            
            # Session Configuration
            SESSION_DRIVER: '${SESSION_DRIVER}'
            SESSION_LIFETIME: '${SESSION_LIFETIME}'
            SESSION_ENCRYPT: '${SESSION_ENCRYPT}'
            SESSION_PATH: '${SESSION_PATH}'
            SESSION_DOMAIN: '${SESSION_DOMAIN}'
            
            # Log Configuration
            LOG_CHANNEL: '${LOG_CHANNEL}'
            LOG_STACK: '${LOG_STACK}'
            LOG_DEPRECATIONS_CHANNEL: '${LOG_DEPRECATIONS_CHANNEL}'
            LOG_LEVEL: '${LOG_LEVEL}'
            
            # Broadcast Configuration
            BROADCAST_CONNECTION: '${BROADCAST_CONNECTION}'
            
            # Filesystem Configuration
            FILESYSTEM_DISK: '${FILESYSTEM_DISK}'
        volumes:
            - '.:/app'
            - '/app/vendor'
            - 'sail-storage:/app/storage'
            - 'sail-bootstrap:/app/bootstrap/cache'
        depends_on:
            pgsql:
                condition: service_healthy
        networks:
            - sail

    pgsql:
        container_name: 'ptmms-pgsql'
        image: 'postgres:18-alpine'
        ports:
            - '${FORWARD_DB_PORT:-5432}:5432'
        environment:
            PGPASSWORD: '${DB_PASSWORD:-secret}'
            POSTGRES_DB: '${DB_DATABASE}'
            POSTGRES_USER: '${DB_USERNAME}'
            POSTGRES_PASSWORD: '${DB_PASSWORD:-secret}'
        volumes:
            - 'sail-pgsql:/var/lib/postgresql'
            - './vendor/laravel/sail/database/pgsql/create-testing-database.sql:/docker-entrypoint-initdb.d/10-create-testing-database.sql'
        networks:
            - sail
        healthcheck:
            test:
                - CMD
                - pg_isready
                - '-q'
                - '-d'
                - '${DB_DATABASE}'
                - '-U'
                - '${DB_USERNAME}'
            retries: 3
            timeout: 5s
networks:
    sail:
        driver: bridge
volumes:
    sail-pgsql:
        driver: local
    sail-storage:
        driver: local
    sail-bootstrap:
        driver: local
